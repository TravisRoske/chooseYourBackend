<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>MySQL Test Rest</title>
    <link rel="stylesheet" type="text/css" href="console.css">
  </head>
  <body>
    <h1>MySQL</h1>
    <form>
      <label for="id">Object id:</label>
      <input type="text" id="id" name="id"><br><br>

      <label for="firstName">First Name:</label>
      <input type="text" id="firstName" name="firstName"><br><br>

      <label for="lastName">Last Name:</label>
      <input type="text" id="lastName" name="lastName"><br><br>

      <label for="username">Username:</label>
      <input type="text" id="username" name="username"><br><br>

      <label for="password">Password:</label>
      <input type="password" id="password" name="password"><br><br>

      <button type="button" onclick="getRecord()">Get Record</button>
      <button type="button" onclick="createRecord()">Create Record</button>
      <button type="button" onclick="updateRecord()">Update Record</button>
      <button type="button" onclick="deleteRecord()">Delete Record</button>
    </form>

    
    <div id="display">
        <h1>Display</h1>
        <p id="temp"></p>
    </div>


    

    <script>
        const url = "http://localhost:8080/ts/mysql/query/";


        //maybe only render the console once this promise resolves
        let userid = ""
        getUserid().then((result) => userid = result)

        //Get a userid from the server, or use saved id    
        function getUserid() {
            const idurl = "http://localhost:8081/assignid"
            let headers = {}
            const currid = localStorage.getItem("userid")

            let prom = new Promise((resolve, reject) => {
                if(currid && currid != "null" && currid != "undefined" ) {
                    resolve(currid)
                }
                fetch(idurl, {
                    method : "GET",
                    headers : headers
                })
                .then((response) => {
                    return response.json()
                })
                .then((result) => {
                    localStorage.setItem("userid", result.userid)
                    resolve(result.userid)
                })    
                .catch((err) => {
                    console.log(err)
                    reject()
                })
            })
            return prom
        }

        async function getRecord() {
            console.log(userid)

            const idInput = document.querySelector('#id').value;
            let idString = ''
            if(idInput){
                idString = '?objectid=' + idInput
            }
            fetch(url + userid + idString, {
                method: 'GET'
            })
            .then((response) => {
                return response.json()
            })
            .then((result) => {
                console.log(result)
                display(result)
            })
        }

        async function createRecord() {

            const firstNameInput = document.querySelector('#firstName').value;
            const lastNameInput = document.querySelector('#lastName').value;
            const usernameInput = document.querySelector('#username').value;
            const passwordInput = document.querySelector('#password').value;
            console.log("VALS", firstNameInput, lastNameInput, usernameInput, passwordInput)

            fetch(url + userid, {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json"
                },
                body : JSON.stringify({
                    "firstName": firstNameInput, 
                    "lastName":  lastNameInput, 
                    "userName":  usernameInput,
                    "password":  passwordInput
                })
            })
            .then((response) => {
                return response.json()
            })
            .then((result) => {
                console.log(result)
                display(result)
            })
        }

        async function updateRecord() {

            const firstNameInput = document.querySelector('#firstName').value;
            const lastNameInput = document.querySelector('#lastName').value;
            const usernameInput = document.querySelector('#username').value;
            const passwordInput = document.querySelector('#password').value;
            const idInput = document.querySelector('#id').value;
            let idString = ''
            if(idInput){
                idString = '?objectid=' + idInput
            }

            fetch(url + userid + idString, {
                method: 'PUT',
                headers: {
                    "Content-Type": "application/json"
                },
                body : JSON.stringify({
                    "firstName": firstNameInput, 
                    "lastName":  lastNameInput, 
                    "userName":  usernameInput,
                    "password":  passwordInput
                })
            })
            .then((response) => {
                return response.json()
            })
            .then((result) => {
                console.log(result)
                display(result)
            })
        }

        async function deleteRecord() {

            const idInput = document.querySelector('#id').value;
            let idString = ''
            if(idInput){
                idString = '?objectid=' + idInput
            }
            fetch(url + userid + idString, {
                method: 'DELETE'
            })
            .then((response) => {
                return response.json()
            })
            .then((result) => {
                console.log(result)
                display(result)
            })
        }




        function display(data){
            document.querySelector('#temp').innerHTML = JSON.stringify(data)
        }


    </script>
  </body>
</html>